import{r as c,j as e,aj as ne,T as f,ak as te,S as v,f as k,B as y,ax as ie,ay as ae,az as oe,aA as le,aB as re,aC as ce,aD as ue,aE as de}from"./vendor-mui-DDhzcgPb.js";import{z as r,e as M,d as J,u as K,t as pe,g as me,h as Q,B as xe,F as he,M as je,S as Z,C as R,i as H,E as ge,j as be,k as Ee,l as fe,m as Ce,n as E,U as L,L as Se,o as Ie,p as De,O as N,q as Ae,D as Fe,s as ye,v as Me}from"./index-Bm6skYEt.js";import{C as ke}from"./ClassMenu-B9UyJvPF.js";import{N as ve}from"./index-BVLnVObh.js";import"./vendor-utils-BRiujrGV.js";import"./vendor-router-B6q9Nvgf.js";const $=r.object({title:r.string().min(1,M("Tiêu đề")),classId:r.number().min(1,M("Tên lớp học")),subjectId:r.number().min(1,M("Tên môn học")),author:r.string(),file:r.any().refine(n=>n instanceof File&&n.size>0,M("File"))}),Te=$.omit({file:!0}).merge(r.object({file:r.any().optional()})),we=({refetch:n,open:C,onClose:x})=>{var V,W,_,X,Y,q;const T="https://online-learning-aws.s3.us-east-1.amazonaws.com/pdfs/",{classId:w,subjectId:P,classes:o,selectedDocument:t}=J(),u=(V=t.fileUrl)==null?void 0:V.split(T)[1],[S,m]=c.useState(u),I=K({resolver:pe(t.id?Te:$),values:{title:t.title||"",classId:t.classId||w,subjectId:t.subjectId||P,author:t.author,file:void 0}}),{register:d,handleSubmit:D,watch:l,setValue:h,reset:B,formState:{errors:p}}=I,A=l("classId"),O=c.useMemo(()=>o.map(a=>({key:a.name,value:a.id})),[o]),U=c.useMemo(()=>{var b,G;return(G=((b=o.find(F=>F.id===A))==null?void 0:b.subjects)||[])==null?void 0:G.map(F=>({key:F.name,value:F.id}))},[A,o]),{mutate:s,isPending:j}=me(),{mutate:ee,isPending:se}=Q(),z=D(i=>{if(i.file){if(t.id){ee({documentId:t.id,payload:{title:i.title,file:i.file,author:i.author}},{onSuccess(a){g(),n==null||n(),xe.success(a.message)}});return}s({title:i.title,subjectId:Number(i.subjectId),file:i.file,author:i.author},{onSuccess(){g(),n==null||n()}})}}),g=()=>{B(),m(null),x==null||x()};return c.useEffect(()=>{},[]),e.jsx(he,{...I,children:e.jsx(ne,{open:C,onClose:g,children:e.jsx(je,{children:e.jsxs("form",{onSubmit:z,children:[e.jsxs(Z,{children:[e.jsx(f,{variant:"h6",children:"Đăng tải"}),e.jsx(te,{onClick:g,sx:{cursor:"pointer"}})]}),e.jsxs(v,{flexDirection:"column",gap:4,marginY:2,children:[e.jsx(R,{label:"Tiêu đề",registerProps:d("title"),errorMsg:(W=p.title)==null?void 0:W.message}),e.jsx(H,{label:"Tên lớp học",registerProps:d("classId"),errorMsg:(_=p.classId)==null?void 0:_.message,selectOptions:O,disabled:!!t.id}),e.jsx(H,{label:"Tên môn học",registerProps:d("subjectId"),errorMsg:(X=p.subjectId)==null?void 0:X.message,selectOptions:U,disabled:!!t.id}),e.jsx(R,{label:"Tên tác giả",registerProps:d("author"),errorMsg:(Y=p.author)==null?void 0:Y.message}),e.jsxs(v,{flexDirection:"column",children:[e.jsxs(k,{variant:"outlined",component:"label",sx:{textTransform:"none"},children:["Chọn file từ máy tính",e.jsx("input",{hidden:!0,accept:"application/pdf",type:"file",...d("file",{onChange:i=>{var b;const a=((b=i.target.files)==null?void 0:b[0])||null;h("file",a,{shouldValidate:!0}),h("title",a?a.name.split(".")[0]:""),m(a.name)}})})]}),(u||S)&&e.jsx(f,{variant:"body2",color:"text.secondary",sx:{marginTop:1},children:u||S}),e.jsx(ge,{message:(q=p.file)==null?void 0:q.message})]})]}),e.jsxs(be,{marginTop:4,gap:2,children:[e.jsx(k,{onClick:g,children:"Huỷ bỏ"}),e.jsx(k,{variant:"contained",type:"submit",disabled:j||se,onClick:z,children:"Lưu"})]})]})})})})},Re=()=>{const{user:n}=Ee(),{subjectId:C,setSelectedDocument:x}=J(),[T,w]=c.useState({}),[P,o]=c.useState(!1),[t,u]=c.useState(!1),[S,m]=c.useState(0),{register:I,handleSubmit:d}=K({}),D=d(s=>{w(s)}),{data:l,isFetching:h}=fe({...T,subjectId:C||void 0}),{mutate:B}=Q(),{mutate:p}=Ce(),A=s=>{window.open(s,"_blank")},O=s=>{p(s,{onSuccess(){u(!1)}})},U=s=>{B({documentId:s.id,payload:{...s,views:s.views+1}})};return e.jsx(ke,{children:e.jsxs("form",{onSubmit:D,children:[e.jsxs(y,{padding:2,children:[e.jsxs(Z,{children:[e.jsx(y,{children:e.jsx(f,{variant:"h6",marginTop:2,sx:{display:{xs:"none",sm:"block"}},children:"TÀI LIỆU NỔI BẬT"})}),e.jsxs(E,{gap:2,children:[n.role===L.RoleAdmin&&e.jsxs(e.Fragment,{children:[e.jsx(k,{variant:"contained",sx:{display:{xs:"none",md:"block"}},onClick:()=>o(!0),children:"Đăng tải"}),e.jsx(ie,{fontSize:"large",sx:{cursor:"pointer",display:{xs:"block",md:"none"}},onClick:()=>o(!0)})]}),e.jsxs(E,{gap:2,children:[e.jsx(R,{label:"Tìm kiếm theo tiêu đề",registerProps:I("title"),showLabel:!1}),e.jsx(ae,{onClick:D,sx:{cursor:"pointer",width:32,height:32}})]})]})]}),h?e.jsx(Se,{isFullScreen:!1}):e.jsx(ve,{length:(l==null?void 0:l.length)||0}),e.jsx(Ie,{children:!h&&(l==null?void 0:l.map(s=>e.jsx(De,{onClick:()=>{m(s.id),U(s),A(s.fileUrl)},children:e.jsxs(oe,{children:[e.jsxs(y,{paddingX:2,sx:{position:"relative"},children:[e.jsx(N,{variant:"h6",lines:2,sx:{fontWeight:"bold",color:Ae,height:64,paddingRight:5},children:s.title}),n.role===L.RoleAdmin&&e.jsx(Fe,{onClick:j=>{j.stopPropagation(),m(s.id),u(!0)}}),n.role===L.RoleAdmin&&e.jsx(ye,{onClick:j=>{j.stopPropagation(),x(s),o(!0),m(s.id)}}),e.jsxs(E,{marginTop:1,gap:1,children:[e.jsx(le,{sx:{fontSize:26}}),e.jsx(N,{sx:{textAlign:"center"},children:s.category})]})]}),e.jsx(re,{sx:{paddingY:2}}),e.jsxs(y,{paddingX:2,children:[e.jsxs(E,{justifyContent:"space-between",marginTop:4,children:[e.jsxs(v,{gap:1,children:[e.jsx(ce,{}),e.jsx(f,{children:s.views})]}),e.jsxs(v,{gap:1,children:[e.jsx(ue,{}),e.jsx(f,{children:s.downloads})]})]}),e.jsxs(E,{marginTop:1,gap:1,children:[e.jsx(de,{}),e.jsxs(N,{lines:1,children:["Tác giả: ",s.author]})]})]})]})},s.id)))})]}),e.jsx(we,{open:P,onClose:()=>o(!1)}),e.jsx(Me,{open:t,onClose:()=>u(!1),content:"Bạn có chắc chắn muốn xoá nó không?",onSubmit:()=>O(S)})]})})};export{Re as default};
